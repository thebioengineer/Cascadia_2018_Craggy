---
title: "Train Delays in France - TidyTuesday 02-25-2019"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r load_libraries}
# devtools::install_github("thebioengineer/tidytuesdayR")
library(tidytuesdayR)
library(tidyverse)
library(gganimate)
library(rvest)
library(maps)

tt_data<-tt_load(2019,week=9)
tt_data
```

```{r transform}


#which departure/arrival pairs have longest rides?
station_pairings<-tt_data$full_trains%>%
  group_by(departure_station,arrival_station)%>%
  summarise(mean_journey_time=sum(journey_time_avg*total_num_trips)/sum(total_num_trips))%>%
  ungroup%>%
  filter(mean_journey_time>quantile(.data$mean_journey_time,.80))%>%
  unite(routes,departure_station,arrival_station,sep = " -> ")%>%
  pull(routes)


Trains_delays<-tt_data$full_trains%>%
  unite(route,departure_station,arrival_station,sep = " -> ") %>% 
  select(year,month,service,route,total_num_trips,starts_with("num_greater"))%>%
  group_by(year,month,route)%>%
  summarize(totalTrips=sum(total_num_trips),
            late_15=sum(num_greater_15_min_late),
            late_30=sum(num_greater_30_min_late),
            late_60=sum(num_greater_60_min_late),
            perc_15_late=late_15/totalTrips*100,
            perc_30_late=late_30/totalTrips*100,
            perc_60_late=late_60/totalTrips*100)%>%
  arrange(route,year,month)%>%
  mutate(date=as.Date(paste(year,month,"1",sep = "-"),format="%Y-%m-%d"))%>%
  ungroup


# Get "directions" for train routes
directions<-Trains_delays%>%
  select(route)%>%
  distinct%>%
  separate(route,c("origin","destination")," -> ")%>%
  unlist()%>%
  unique

getCoords<-function(station){
  url<-paste0("https://en.wikipedia.org/w/index.php?search=",gsub(" ","+",station),"+railway+station")
  wiki_page<-xml2::read_html(url)
  coords<-wiki_page%>%
    rvest::html_node(".geo-dms")%>%
    rvest::html_text()

  coords<-clean_coords(strsplit(coords," ")[[1]])
  names(coords)<-c("long","lat")
  coords
}

clean_coords<-function(coord){
  coord_dec<-str_extract_all(coord, "\\-*\\d+\\.*\\d*")%>%
    purrr::map(as.numeric)%>%
    purrr::map(~.x[1] + (.x[2]/60) + (.x[3]/3600))
  
  coord<-purrr::map2(coord_dec,coord,
                     function(.x,.y){
                       dirs<-data.frame(val=rep(1,length(.x)))
                       dirs$coord<-toupper(str_sub(.y,-1))
                       dirs$val[dirs$coord%in%c("S","W")]<--1
                       .x*dirs$val
                     })
  
  data.frame(coord)
}

station_coords<-directions%>%
  purrr::map_df(~data.frame(station=.x,getCoords(.x),stringsAsFactors = FALSE))


# https://ggplot2.tidyverse.org/reference/geom_map.html
France<-map_data('france')




```





