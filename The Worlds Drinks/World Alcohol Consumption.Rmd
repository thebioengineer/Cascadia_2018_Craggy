---
title: "Tidy Tuesday: World Alcohol Consumption"
author: "Ellis Hughes"
output: 
  html_document:
    keep_md: yes
editor_options: 
  chunk_output_type: console
---

This weeks [#TidyTuesday](https://github.com/rfordatascience/tidytuesday) is once again provided by [FiveThirtyEight.com](https://fivethirtyeight.com/). This time it is a topic I think most of us can relate to, [alcohol consumption](https://fivethirtyeight.com/features/dear-mona-followup-where-do-people-drink-the-most-beer-wine-and-spirits/). 

FiveThirtyEight kindly took the WHO data on beverage consumption and broke it down into number of servings per captita of Beer, Wine and Spirits. They did some fun stuff with the data, but I was curous which countries are the most similar in the choices of alcohol consumption.

```{r import and load}
library(tidyverse)
library(plotly)
library(httr)  
library(rgdal)  

alcohol<-read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/week13_alcohol_global.csv")
set.seed(9917)
```

I am more interested in what the world chooses to drink when they do, not what is the total volume. Then which countries were the most similar.

I normalized each beverage type by the total number of beverages, and then performed a PCA. After the PCA, I ran kmeans with 5 centers. In my mind there would be 5 groups of drinkers; Non-Drinkers, one of each of the three categories, and one equal oportunist drinker.

After plotting the first two PC's, there were no obvious groupings when the points are not colored, but it did look like there were trends. They did get highlighted by the coloring.

```{r normalization}
NormAlcohol<-alcohol%>%
  mutate(TotalServings=beer_servings+spirit_servings+wine_servings,
         beer=beer_servings/TotalServings,
         spirits=spirit_servings/TotalServings,
         wine=wine_servings/TotalServings
         )%>%
  select(country,beer,spirits,wine)%>%
  replace_na(list(beer=0,spirits=0,wine=0))%>%
  data.frame%>%
  `rownames<-`(.,.$country)

alcoholPRCOMP<-NormAlcohol%>%
  select(-country)%>%
  prcomp()

cluster<-alcoholPRCOMP$x%>%
  data.frame%>%
  mutate(Cluster=kmeans(.,centers=5)%>%'$'(cluster),
         country=rownames(.))


ggplot(cluster)+
  geom_point(aes(x = PC1, y=PC2, color=factor(Cluster)))

```

When I took a look at the actual clusters average consumption, it was not exacly how I thought. There were the non-drinkers/equal-opportunity grouped together. Likely due to no specific direction in the PCs. Beer and Spirits both had clear groups. Then there were two groups, a beer and wine group, and a mainly beer but drinks spirits.

```{r Drinking_clusters}
summary_groups<-NormAlcohol%>%
  mutate(country=rownames(.))%>%
  merge(cluster[,c("Cluster","country")])%>%
  group_by(Cluster)%>%
  summarise(
    # minbeer=min(beer),
    # medianbeer=median(beer),
    beer=mean(beer),
    # maxnbeer=max(beer),
            
    # minwine=min(wine),
    # medianwine=median(wine),
    wine=mean(wine),
    # maxnwine=max(wine),
            
    # minspirits=min(spirits),
    # medianspirits=median(spirits),
    spirits=mean(spirits),
    # maxnspirits=max(spirits),
            
    countries=paste(country,collapse=", "))

knitr::kable(summary_groups)

```

I am now going to visualize these groups on a choropleth chart. I must admit that I don't have experience plotting on choropleths. To do this, I somewhat blindly followed the instructions from [this site](https://rud.is/b/2015/07/09/faceted-world-population-by-income-choropleths-in-ggplot/).


```{r choropleth}

# this ensures you only download the shapefile once and hides
# errors and warnings. remove `try` and `invisible` to see messages
try(invisible(GET("http://www.pewglobal.org/wp-content/lib/js/world-geo.json",write_disk("world-geo.json"))), silent=TRUE)

world <- readOGR("world-geo.json")
world_wt <- spTransform(world, CRS("+proj=robin"))
world_map <- fortify(world_wt)%>%
  left_join(data_frame(id=rownames(world@data), name=world@data$name)) %>%
  select(-id) %>%
  rename(country=name) 

GroupedCountries<-summary_groups%>%
  mutate(DrinkerType=c("Non-Drinkers","Spirits","Beer and Wine","Beer","Beer and Spirits"))%>%
  separate_rows(countries,sep = ", ")%>%
  rename(country=countries)%>%
  merge(alcohol,by="country")%>%
  mutate(Color=rgb(beer,wine,spirits),
         hover=paste("Country:",country,"<br>Group:",DrinkerType,
                     "<br>Beer:",beer_servings,"<br>Sprits:",spirit_servings,"<br>Wine:",wine_servings))%>%
  merge(world_map,by="country")


gg<-ggplot() +
  geom_map(data=GroupedCountries,map=world_map,aes(map_id = id, x=long, y=lat, group= group, fill=Color))

g <- gg + theme_map()
 
gg <- gg + theme(panel.margin=unit(1, "lines"))
gg <- gg + theme(plot.title=element_text(face="bold", hjust=0, size=24))
gg <- gg + theme(legend.title=element_text(face="bold", hjust=0, size=12))
gg <- gg + theme(legend.text=element_text(size=10))
gg <- gg + theme(strip.text=element_text(face="bold", size=10))
gg <- gg + theme(strip.background=element_blank())
gg <- gg + theme(legend.position="bottom")
 
gg

```

